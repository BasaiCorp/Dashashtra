<%
// Set the current page for active menu highlighting
const currentPage = 'servers';

// Set the page title
const pageTitle = 'My Servers - ' + extra.dashboard.title;
%>

<!DOCTYPE html>
<html lang="en">
<%- include('./components/head') %>

<body class="min-h-screen bg-dark-base">
    <!-- Calculate server resources -->
    <%
        let ram = 0;
        let disk = 0;
        let cpu = 0;
        let servers = 0;
        
        if (pterodactyl && pterodactyl.relationships && pterodactyl.relationships.servers && pterodactyl.relationships.servers.data) {
            servers = pterodactyl.relationships.servers.data.length;
            
            for (let i = 0, len = pterodactyl.relationships.servers.data.length; i < len; i++) {
                ram = ram + (typeof pterodactyl.relationships.servers.data[i].attributes.limits.memory == "number" ? pterodactyl.relationships.servers.data[i].attributes.limits.memory : 0);
                disk = disk + (typeof pterodactyl.relationships.servers.data[i].attributes.limits.disk == "number" ? pterodactyl.relationships.servers.data[i].attributes.limits.disk : 0);
                cpu = cpu + (typeof pterodactyl.relationships.servers.data[i].attributes.limits.cpu == "number" ? pterodactyl.relationships.servers.data[i].attributes.limits.cpu : 0);
            }
        }
        
        // User data
        const userData = {
            id: userinfo.id,
            username: userinfo.username || userinfo.email.split('@')[0],
            email: userinfo.email,
            isAdmin: typeof req.session !== 'undefined' ? req.session.isAdmin : false
        };
        
        const packageData = typeof packages !== 'undefined' ? packages : {
            ram: 0,
            disk: 0,
            cpu: 0,
            servers: 0
        };
        
        // Calculate total resources (package + extra)
        const extraData = typeof extraresources !== 'undefined' ? extraresources : {
            ram: 0,
            disk: 0,
            cpu: 0,
            servers: 0
        };
        
        const totalRam = packageData.ram + extraData.ram;
        const totalDisk = packageData.disk + extraData.disk;
        const totalCpu = packageData.cpu + extraData.cpu;
        const totalServers = packageData.servers + extraData.servers;
        
        // Available resources
        const availableRam = totalRam - ram;
        const availableDisk = totalDisk - disk;
        const availableCpu = totalCpu - cpu;
        const availableServers = totalServers - servers;
    %>

    <!-- Notification Toast Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 flex flex-col items-end space-y-2"></div>

    <!-- Include Header Component -->
    <%- include('./components/header') %>

    <div class="flex h-screen pt-16">
        <!-- Include Sidebar Component -->
        <%- include('./components/sidebar') %>

        <!-- Main Content -->
        <div class="p-4 sm:ml-64 pt-5 w-full main-content">
            <div class="p-4">
                <!-- Welcome Message -->
                <div class="mb-8 glass-card p-6 rounded-xl animate-fade-in">
                    <h1 class="text-3xl font-bold mb-2">Your Servers</h1>
                    <p class="text-gray-400">Manage and monitor all your game servers in one place.</p>
                </div>

                <!-- Resource Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-slide-up" style="animation-delay: 0.1s;">
                    <!-- RAM Card -->
                    <div class="gradient-border">
                        <div class="stat-card h-full bg-dark-card rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 rounded-lg bg-indigo-500/20 flex items-center justify-center mr-3">
                                        <i class="fas fa-memory text-indigo-400 text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg font-semibold text-white">Available RAM</h3>
                                        <p class="text-gray-400 text-sm">Memory Resources</p>
                                    </div>
                                </div>
                                <span class="text-xl font-bold text-white"><%= availableRam %> <span class="text-gray-400 text-sm">/ <%= totalRam %> MB</span></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ram" style="width: <%= ((ram / totalRam) * 100).toFixed(2) + '%' %>"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Disk Card -->
                    <div class="gradient-border">
                        <div class="stat-card h-full bg-dark-card rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 rounded-lg bg-green-500/20 flex items-center justify-center mr-3">
                                        <i class="fas fa-hdd text-green-400 text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg font-semibold text-white">Available Disk</h3>
                                        <p class="text-gray-400 text-sm">Storage Resources</p>
                                    </div>
                                </div>
                                <span class="text-xl font-bold text-white"><%= availableDisk %> <span class="text-gray-400 text-sm">/ <%= totalDisk %> MB</span></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill disk" style="width: <%= ((disk / totalDisk) * 100).toFixed(2) + '%' %>"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CPU Card -->
                    <div class="gradient-border">
                        <div class="stat-card h-full bg-dark-card rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center mr-3">
                                        <i class="fas fa-microchip text-amber-400 text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg font-semibold text-white">Available CPU</h3>
                                        <p class="text-gray-400 text-sm">Processor Resources</p>
                                    </div>
                                </div>
                                <span class="text-xl font-bold text-white"><%= availableCpu %> <span class="text-gray-400 text-sm">/ <%= totalCpu %>%</span></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill cpu" style="width: <%= ((cpu / totalCpu) * 100).toFixed(2) + '%' %>"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Servers Card -->
                    <div class="gradient-border">
                        <div class="stat-card h-full bg-dark-card rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center mr-3">
                                        <i class="fas fa-server text-purple-400 text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg font-semibold text-white">Available Servers</h3>
                                        <p class="text-gray-400 text-sm">Server Slots</p>
                                    </div>
                                </div>
                                <span class="text-xl font-bold text-white"><%= availableServers %> <span class="text-gray-400 text-sm">/ <%= totalServers %></span></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill servers" style="width: <%= ((servers / totalServers) * 100).toFixed(2) + '%' %>"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Server List -->
                <div class="glass-card rounded-xl border border-gray-700 p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-server text-primary-400 mr-3"></i>
                            Your Game Servers
                        </h2>
                        <a href="/create" class="btn-primary inline-flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Create Server
                        </a>
                    </div>

                    <% if (pterodactyl && pterodactyl.relationships && pterodactyl.relationships.servers && pterodactyl.relationships.servers.data && pterodactyl.relationships.servers.data.length > 0) { %>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <% pterodactyl.relationships.servers.data.forEach(server => { %>
                                <div class="gradient-border">
                                    <div class="bg-dark-card rounded-lg p-6 h-full">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 rounded-lg bg-primary-500/20 flex items-center justify-center mr-3">
                                                    <i class="fas fa-server text-primary-400"></i>
                                                </div>
                                                <div>
                                                    <h3 class="text-lg font-semibold text-white"><%= server.attributes.name %></h3>
                                                    <p class="text-xs text-gray-400"><%= server.attributes.identifier %></p>
                                                </div>
                                            </div>
                                            <div class="flex space-x-2">
                                                <a href="<%= settings.pterodactyl.domain %>/server/<%= server.attributes.identifier %>" target="_blank" class="p-2 bg-dark-lighter rounded-lg text-gray-400 hover:text-white transition-colors duration-200">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                <button onclick="deleteServer('<%= server.attributes.identifier %>')" class="p-2 bg-dark-lighter rounded-lg text-red-400 hover:text-red-300 transition-colors duration-200">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 space-y-3">
                                            <!-- RAM Usage -->
                                            <div>
                                                <div class="flex justify-between text-xs mb-1">
                                                    <span class="text-gray-400">RAM</span>
                                                    <span class="text-gray-400"><%= server.attributes.limits.memory %> MB</span>
                                                </div>
                                                <div class="progress-bar">
                                                    <div class="progress-bar-fill ram" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- Disk Usage -->
                                            <div>
                                                <div class="flex justify-between text-xs mb-1">
                                                    <span class="text-gray-400">Disk</span>
                                                    <span class="text-gray-400"><%= server.attributes.limits.disk %> MB</span>
                                                </div>
                                                <div class="progress-bar">
                                                    <div class="progress-bar-fill disk" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- CPU Usage -->
                                            <div>
                                                <div class="flex justify-between text-xs mb-1">
                                                    <span class="text-gray-400">CPU</span>
                                                    <span class="text-gray-400"><%= server.attributes.limits.cpu %>%</span>
                                                </div>
                                                <div class="progress-bar">
                                                    <div class="progress-bar-fill cpu" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                                            <span class="text-xs text-gray-400"><%= server.attributes.node %></span>
                                            <span class="px-2 py-1 text-xs rounded-full <%= server.attributes.status === 'running' ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400' %>">
                                                <%= server.attributes.status === 'running' ? 'Online' : 'Offline' %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-12">
                            <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-dark-lighter flex items-center justify-center">
                                <i class="fas fa-server text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-medium text-white mb-2">No Servers Found</h3>
                            <p class="text-gray-400 mb-6">You don't have any servers yet. Create your first server to get started.</p>
                            <a href="/create" class="btn-primary inline-flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                Create Your First Server
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Footer Component -->
    <%- include('./components/footer') %>

    <!-- Include Scripts Component -->
    <%- include('./components/scripts') %>

    <!-- Server-specific scripts -->
    <script>
        // Server deletion function
        function deleteServer(identifier) {
            if (confirm('Are you sure you want to delete this server? This action cannot be undone.')) {
                window.location.href = `/servers/delete/${identifier}`;
            }
        }
    </script>
</body>
</html>
